package tdigest

import "testing"

func TestFuzzPanicRegressions(t *testing.T) {
	// This test contains a list of byte sequences discovered by
	// github.com/dvyukov/go-fuzz which, at one time, caused tdigest to panic. The
	// test just makes sure that they no longer cause a panic.
	testcase := func(crasher []byte) func(*testing.T) {
		return func(*testing.T) {
			v := new(TDigest)
			err := v.UnmarshalBinary(crasher)
			if err != nil {
				return
			}
			_, err = v.MarshalBinary()
			if err != nil {
				panic(err)
			}
		}
	}
	t.Run("fuzz1", testcase([]byte{
		0x01, 0x00, 0x00, 0x00, 0x30, 0x30, 0x30, 0x30,
		0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
		0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
		0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0xfc,
	}))
	t.Run("fuzz2", testcase([]byte{
		0x01, 0x00, 0x00, 0x00, 0xdb, 0x46, 0x5f, 0xbd,
		0xdb, 0x46, 0x00, 0xbd, 0xe0, 0xdf, 0xca, 0xab,
		0x37, 0x31, 0x37, 0x32, 0x37, 0x33, 0x37, 0x34,
		0x37, 0x35, 0x37, 0x36, 0x37, 0x37, 0x37, 0x38,
		0x37, 0x39, 0x28,
	}))

}
